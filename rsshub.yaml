-
  name: Install RSSHub
  hosts: localhost
  become: true
  tasks:
    -
      name: Install GPG keys for repos
      apt_key:
        url: '{{ item }}'
        state: present
      with_items:
        - https://deb.nodesource.com/gpgkey/nodesource.gpg.key
        - https://dl.yarnpkg.com/debian/pubkey.gpg
    -
      name: Install repos
      apt_repository:
        repo: '{{ item }}'
        state: present
        update_cache: yes
      with_items:
        - deb https://deb.nodesource.com/node_12.x focal main
        - deb https://dl.yarnpkg.com/debian/ stable main
    -
      name: Install prerequisites
      apt:
        name: ['nodejs', 'yarn', 'build-essential', 'python-is-python2', "redis-server", "nginx"]
        state: present
        update_cache: yes
    -
      name: Start redis
      systemd:
        state: started
        enabled: yes
        name: redis
        daemon_reload: yes
    -
      name: Copy nginx configuration
      copy:
        src: rsshub.nginx.cfg
        dest: /etc/nginx/sites-available/rsshub
    -
      name: Create nginx configuration symlink
      file:
        src: /etc/nginx/sites-available/rsshub
        dest: /etc/nginx/sites-enabled/rsshub
        state: link
    -
      name: Remove default nginx configuration symlink
      file:
        path: /etc/nginx/sites-enabled/default
        state: absent
    -
      name: Start nginx
      systemd:
        state: started
        enabled: yes
        name: nginx
        daemon_reload: yes
    -
      name: Create the user
      user:
        name: rsshub
        create_home: true
        shell: /bin/bash
    -
      name: Clone the repo
      git:
        repo: https://github.com/DIYgod/RSSHub.git
        dest: /home/rsshub/app
        update: yes
    -
      name: Install repo dependencies
      command: yarn install --production
      args:
        chdir: /home/rsshub/app
    -
      name: Copy configuration
      copy:
        src: rsshub.env
        dest: /home/rsshub/app/.env
    -
      name: Own repo to the user
      file:
        path: /home/rsshub/app
        owner: rsshub
        group: rsshub
        recurse: yes
    -
      name: Install the systemd unit
      copy:
        src: rsshub.service
        dest: /etc/systemd/system/rsshub.service
    -
      name: Start the systemd service
      systemd:
        state: started
        enabled: yes
        name: rsshub
        daemon_reload: yes
